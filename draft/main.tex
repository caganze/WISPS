\documentclass[manuscript]{aastex63}

%\usepackage{natbib}
\usepackage{graphics}
\usepackage{amsmath}
\usepackage{ amssymb }

\usepackage{graphicx}
\usepackage{pgffor}
\usepackage{rotating}


\usepackage{pdftexcmds}

\usepackage{xcolor} 
\usepackage{pgffor}  
\usepackage{dpfloat}  

\usepackage{lipsum}

\begin{document}

\newcommand{\meth}{CH$_4$ }
\newcommand{\wat}{H$_2$O }

\newcommand{\indxmeth}{CH$_4$}
\newcommand{\indxwat}{H$_2$O}

\newcommand{\teff}{T$_{eff}$ }
\newcommand{\Msun}{M$_\sun$}
\newcommand{\chisquare}{$\chi^2$}



\title{Beyond the Local Volume: Surface Densities of Ultracool Dwarfs in Deep HST/WFC3 Parallel Fields }

\author[0000-0003-2094-9128]{Christian Aganze}
\author{Adam J. Burgasser }
\affiliation{Department of Physics, University of California, San Diego, CA 92093, USA}

\author{Mathew Malkan}
\affiliation{Department of Physics \& Astronomy, University of California,Los Angeles, CA 90095, USA }

\author{Chih-Chun Hsu}
\affiliation{Department of Physics, University of California, San Diego, CA 92093, USA}

\author[0000-0002-9807-5435]{Christopher A. Theissen}
\affiliation{Department of Physics, University of California, San Diego, CA 92093, USA}

\author{Daniella C. Bardalez Gagliuffi}
\affiliation{Department of Astrophysics, American Museum of Natural History, Central Park West at 79th Street, NY 10024, USA }

\author{Russel Ryan}
\affiliation{Space Telescope Science Institute, 3700 San Martin Dr., Baltimore, MD 21218}
\author{Benne Holwerda}
\affiliation{Department of Physics and Astronomy, 102 Natural Science Building, University of Louisville, Louisville KY 40292, USA}


\begin{abstract}
Ultracool dwarfs (UCDs) of the L, T, and Y spectral classes are the lowest-mass and coldest objects in the Milky Way. Like stars, they are tracers of Galactic structure and star-formation history, while the cooling of substellar UCDS provide additional probes for galactic archeology and chemical evolution. Wide-field optical and infrared surveys have uncovered thousands of UCDs, but primarily in the immediate solar neighborhood (d \textless 100 pc). To push to larger distances, we have searched over 0.5 deg$^2$ of the WFC3 Infrared Spectroscopic Parallel Survey and the 3D-HST parallel survey with low-resolution near-infrared spectra. We report the discovery of 168 M7-T9 and T dwarfs with spectro-photometric distances up to $\sim$2 kpc for L dwarfs and $\sim$ 400 pc for T dwarfs. We model the number density distribution with population simulations incorporating various assumptions of the intrinsic MF and birth rates, accounting for UCD evolutionary models and Galactic structure. We under-predict the number density of T dwarfs in our simulation, reflecting a larger scale height (h \textgreater 1000 pc) for these old populations. Future infrared sky surveys conducted with the James Webb Space Telescope (JWST) or the Euclid mission will put finer constraints on the true scale height of UCDS. We predict that Euclid will yield $\sim$ $10^4$ L dwarfs and $\sim$ $10^4$ T dwarfs spectra in the Euclid South and Euclid Fornax fields alone for a limiting magnitude of J=24, providing enough statistics to fully characterize UCDs in the Galactic context.

\end{abstract}



%Introduction
\section{Introduction}

The structure and evolution of the Milky Way is largely inferred from heterogeneous spatial and kinematic distributions of its stars. Star-count data show that the overall structure conforms to a younger population fit to one or more exponential disks and an older population fit to a power-law or oblate spheroid \citep{1978AJ.....83.1163D,1981ApJS...47..357B,2008ApJ...673..864J}; and models show that the disk started forming stars 8--11 Gyr ago, while the halo star-formation history dates to 10--13 Gyr ago from possible multiple merger events. Hence, halo stellar populations contain stars with ages comparable to the age the universe \citep{1998ApJ...497..294L,2009ARA&A..47..371T,2013A&A...560A.109H}. Questions relating to the formation and evolution of the Galaxy through its stars constitute the field of Galactic archeology \citep{1987ARA&A..25..603F,2012ARA&A..50..251I}, which, through the usage of large sky surveys (e.g the Sloan Digital Sky Survey, \citealt{2000AJ....120.1579Y}), has enabled a 6-dimensional depiction of the Galaxy. The Gaia mission \citep{,2018A&A...616A...1G} has recently contributed to our understanding of the Milky Way. Some of the notable discoveries include major merger events that formed the inner stellar halo and thick disk (Gaia-Enceladus/Gaia sausage: \citealt{2018Natur.563...85H,2018MNRAS.478..611B, 2018ApJ...856L..26M,Gallart_2019}, and the Sequoia event: \citealt{2018ApJ...856L..26M,2019MNRAS.488.1235M}), the discovery and characterization of hypervelocity stars \citep{2018MNRAS.479.2789B}, stellar streams as probes of the Galactic potential and dark matter profile \citep{Boubert_2018,2018MNRAS.481.3442M,2019arXiv190908924K}. The Gaia mission has also enabled the discovery of substructure in the solar neighborhood in the galactic disk caused by phase mixing in velocity space, from possible interactions with the spiral structure of the Galaxy \citep{2018Natur.561..360A}.

Ultracool dwarfs (UCDs; M $\lesssim$0.1\Msun, {\teff} $\lesssim$3000K; \citealt{2005ARA&A..43..195K}) provide a new approach for studying the Galaxy \citep{2004ApJS..155..191B,Ryan2017}. They constitute $\sim$50\% of the total number of stars and they are abundant in every environment in the Galaxy \citep{2007AJ....133..439C,2000ARA&A..38..337C,2001RvMP...73..719B,2010AJ....139.2679B}. Stellar UCDs have lifetimes far in excess of the age of the Galaxy (\textgreater 10$^3$ Gyr, \citealt{1997ApJ...482..420L}), while substellar UCDs (brown dwarfs) do not fuse hydrogen and hence cool down with time \citep{1963PThPh..30..460H}. They have distinct spectra shaped by strong molecular absorption bands that are highly sensitive to temperature, surface gravity and metallicity. The evolution of UCDs provides potential age diagnostics that have already been exploited in stellar cluster studies \citep{1998ASPC..134..394B,luhman2012,martin2017} and searches of young moving groups near the Sun (\citealt{LopezSantiago2006}, \citealt{Gagne2015}, \citealt{Mamajek2015}, \citealt{Faherty2018}).

UCDs have historically been discovered in red optical and infrared sky surveys (DENIS: \citealt{refId0}, SDSS: \citealt{2010AJ....139.1808S, 2014PASP..126..642S,2017AJ....153...92T}, VISTA: \citealt{2012A&A...548A..53L,2014MNRAS.444.1793D}: 2MASS: \citealt{2007AJ....133..439C, 2010ApJS..190..100K}, WISE: \citealt{2011ApJS..197...19K, 2011ApJ...743...50C}, UKIDSS: \citealt{Marocco01062015, 2013MNRAS.430.1171D,2013MNRAS.433..457B,2016A&A...589A..49S}, CFHT-LAS: \citealt{Reyle2010a}, Gaia: \citealt{Reyle2018,2019AJ....157..231K}) but due to their intrinsic faintness, these samples are distance limited ($\leq$100pc). Hence, efforts to measure the UCD luminosity function have focused on compiling volume-limited samples within 20--25 pc of the sun \citep{2007AJ....133..439C, 2008ApJ...676.1281M, Reyle2010a,  2019ApJS..240...19K,2019arXiv190604166B}. Wide-field surveys provide large samples of UCDs, however, these studies do not effectively probe Galactic structure, nor the oldest UCD populations that formed in the early metal-poor Galaxy which may have had a distinct initial mass function \citep{2002MNRAS.332L..65B,2003Natur.425..812B,2003ASPC..287..427B}. To investigate the complete UCD population of the Galaxy these scenarios, it necessary to identify UCDs populations beyond the solar neighborhood and further into the thick disk and halo of the Milky Way.

Deep pencil-beam imaging surveys provide a novel approach to use star-count data in characterization of UCD populations beyond the local volume. A common approach is to use photometric selections cuts anchored to known sample. Early work by \cite{1997ApJ...482..913G} conducted an M-dwarf number counts to measure the halo luminosity function of the Hubble Space Telescope's Wide Field Camera 2 (HST-WFC2) and Planetary Camera (PC1) Deep Fields. They found 47 M dwarfs with M$_V$ \textgreater 13.5, and the distribution was consistent with a power law the mass function that turns at M $\sim$0.6 \Msun from $\alpha$=-1 to $\alpha$=0.44. Subsequent studies by \cite{1997A&A...328....5K, 1997A&A...328...83C} concluded that the contribution of low-mass stars (M$\sim$0.3 \Msun ) to the halo luminosity function is less than 1\%. \cite{2005ApJ...631L.159R} searched 15 deep parallel fields from the Hubble Space Telescope star-count optical data obtained with the ACS instrument, selected by their i-z colors. They estimated a scale of $\sim$350 pc for L \& T dwarfs. Later work by \cite{Ryan2011} found 17 late M, L and T dwarfs in 231.90 arcmin$^2$ of WFC3 imaging of the GOODS fields using a combination of wide and narrow-band filter colors. They estimated a disk scale height of 290$\pm$39pc consistent with work by \cite{2005ApJ...622..319P}. In addition to poor estimate of spectral types, these samples were contaminated with various non-stellar sources that could not be identified in the absence of spectral information. To push towards a larger and pure sample, \cite{Holwerda2014} identified  274 in 227 arcmin$^2$ M-dwarfs (to a limiting magnitude F125W=25) from the HST-WFC3 Brightest of Re-ionizing Galaxies (BoRG, \citealt{2009ApJ...695.1591P}) survey, using an optical and near-infrared colors and determined their spectral types using V-J color-M-dwarf subtype relation (\citealt{2009ApJ...695.1591P}). They found a slightly higher density of M-dwarfs identified in the Northern fields compared to the Southern Fields, and a  disk scale-height of 0.3--4kpc with a dependence on subtype. The overall M-dwarf scale height was $\sim$600 pc, a number that is much larger than previous estimates mostly due to large uncertainties in the fit. \cite{Vledder2016} reanalyzed these data using a Markov Chain Monte Carlo method to fit the statistic to a galactic model including a thin disk, thick disk, and halo component. They derived a scale height of $290^{+20}_{-19}$ pc and a central number density of $0.29^{+0.20}_{-0.13}$ pc$^{-3}$, with no correlation of model parameters with M-dwarf subtype, and consistent with previous studies. However, these studies do not probe statistics for later types. Recent work by \cite{Sorahana2018} found 3665 L dwarfs brighter than z=24 by searching 130 square degrees of the Hyper Suprime-Cam Subaru Strategic Program data and found an average L-dwarf scale height of 340--420 pc. \cite{2019arXiv190310806C} compiled a list of 11,745 photometrically classified L0-T9 dwarfs distances up to $\sim$ 400 pc by searching $\sim$2,400 deg$^2$ of the Dark Energy Survey (DES) data at a limiting magnitude of z=22. They estimated a large scale height of $\sim$ 450 pc. These last two studies provide another constraint on the number density of L dwarfs in the Galaxy using large samples (N\textgreater 10$^3$); however, as in many imaging surveys, poor accuracy in spectral types significantly affects the derived parameters. Ultimately, the large uncertainties on spectral types  of UCDs in imaging surveys poorly constrain their distances, and deep spectroscopic follow-up of these sources is not a priority for precious HST time. 


%Spectroscopic/grism surveys
A parallel approach is to use deep pencil beam samples of spectra in red optical and near infrared (NIR) with no prior selection of source type. NIR spectroscopy, in particular, samples the peak of UCD spectral energy distributions and measure broad molecular features that guide UCD classification schemes (\citealt{2005ARA&A..43..195K}). \citet{2005ApJ...622..319P} identified 18 late M and 2 L dwarfs in the Hubble Ultra Deep Field (HUDF) and estimated their spectral types by fitting templates from \citet{Kirkpatrick2000} to their Gradient-Assisted Photon Echo Spectroscopy (GRAPES, ref) taken with the xxx instrument (ref). This study inferred a disk scale height of 400 $\pm$ 100 pc for M and L dwarfs. Another study by \citet{2009ApJ...695.1591P} used deep Advanced Camera for Surveys (ACS) slitless grism observations of the Probing Evolution And Reionization Spectroscopically (PEARS) fields (as part the Great Observatories Origins Deep Survey (GOODS) fields, \citealt{Giavalisco2004}) down to a z=25 and spectroscopically identified 43 M4-M9 dwarfs. Using a thick and thin disk model, the study estimated a scale height for the thin disk of $\sim$370 pc, and $\sim$100 pc for the thick disk, a halo fraction between 0.00025--0.0005 consistent with previous estimates. 

\citealt{2012ApJ...752L..14M} discovered 3 late T dwarfs the WFC3 infrared Spectroscopic Survey ( WISPS) fields (\citealt{2010ApJ...723..104A}) identified by their strong \meth and \wat absorption features. The sample size was not large enough to put meaningful constraints on the scale height or the luminosity function L and T dwarfs beyond the local volume. In this paper, we expand upon this study by developing an effective method to select UCDs in similar surveys.


Section \ref{sec:data} describes the data, section \ref{sec:selectionp} describes the selection process, section \ref{sec:simulations} discusses the result compared to a Monte-Carlo simulation

\section{Data}\label{sec:data}

We obtained data from two surveys: the WFC3 Infrared Spectroscopic Parallel Survey (WISPS, \citealt{2010ApJ...723..104A}) and 3D-HST ( \citealt{Momcheva2016}, \citealt{2012ApJS..200...13B}, \citealt{Skelton2014}). These two surveys used the IR channel of the WFC3 camera (\citealt{doi:10.1117/12.789581}) providing low-resolution G102 ($\lambda$ = 0.8--1.17 $\micron$, R$\sim$210) and G141 ($\lambda$ = 1.11--1.67 $\micron$, R $\sim$130) grism spectra. Removal of the slit mask allows for the overlapping spectra of the 136$\times$123 arcsec inner FOV of the WFC3 camera. Figure \ref{fig:par1} shows an WCF3 exposure of one of fields in WISP.


\subsection{3D-HST survey data}

%general description: wwhich fields
 3D-HST a parallel survey of 248-orbits spanning $\sim$600 arcmin$^2$ as part of Hubble Cycles 18 \& 19. This survey targets four standard deep extra-galactic fields: The All-wavelength Extended Groth Strip International Survey (AEGIS, \citealt{1538-4357-660-1-L1} ), Cosmic Evolution Survey (COSMOS, \citealt{Scoville2007}), Ultra-Deep Survey(UKIDSS-UDS, \citealt{2007MNRAS.379.1599L}), the Great Observatories Origins Deep Survey (GOODS-South and GOODS-North, \citealt{Giavalisco2004}), using the ACS/G800L and WFC3/G141 grisms in parallel. The goal of 3D-HST is to obtain as the the Cosmic Assembly Near-infrared Deep Extragalactic Legacy Survey(CANDELS survey, \citealt{2011ApJS..197...35G}, \citealt{2011ApJS..197...36K}. However, 3D-HST is only 70\% of the total footprint of the CANDELS. Photometric catalog data products are described in \cite{Skelton2014} and combined data products in \cite{Momcheva2016}

%%observations and survey strategry
 The pointings for 3D-HST are designed to cover CANDELS area, therefore there are additional ground-based and space-based photometry from various other surveys in several optical and infrared filters. Each pointing in 3D-HST is observed by two orbits using the G141 grism and the F140W filter with typical exposure times of 5000 s for G141 AND 800 s for F140W. Observations for most of the pointings in the survey were conducted from October 2010 to November 2012. However, the GOODS-North field is a part of the A Grism H-Alpha SpecTroscopic survey (AGHAST, GO-11600; PI: Wiener) and was observed between sept 16 2009 and sept 26 2010 and re-observed on April 19 and 24 2011, due artifacts and background issue, with exposure times of 800 s for F140W AND 5200S in G141.  

%data reduction
Data reduction in 3D-HST involves reducing the both the direct F140W images and G141 grism images. The full description of the image reduction pipeline is described by \cite{Brammer2012}, \cite{Skelton2014}  and \cite{Momcheva2016}. Raw images were downloaded and passed through a pipeline that consists of removing satellite trails and artifacts through visual inspection, background -subtraction and flat-fielding. The main physical sources of time-dependent background are zodiacal continuum, scattered light and persistence from He emission at 1.083 micron. Both the reduction of the F140W and G141 images involved combining at most four dithered images. A standard method uses a drizzling algorithm implemented by the \texttt{AXe} software \citep{Kuntschner2013, Kummel2009}. However, drizzling is designed to work well for a large number of images. The shortcomings of this method inlude the introduction of correlated noise between adjacent pixels. To avoid these issues, 3D-HST stacked all the dithered images onto one grid, given that the dithered images are all separated by the same number of pixels by the design of the survey. In addition, reducing the grism images require a reference image (different from the obtained F140W direct image) to generate a contamination global model of each pointing, to separate overlapping spectra and orders. The reference image was obtained by coming F125W, F140W AND F160W images of that pointing obtained from \cite{Skelton2014} data products, where the magnitudes of all objects in the fields are scaled to the F140W zero-point, and errors properly propagated. Based on the morphology and the magnitude of each source in the reference image, the full 2D-spectrum of each object was modeled from a 1D SED. This contamination model was then used to correct for overlapping spectra and orders. These 2D-spectra of exactly 312 pixels each are then extracted. The reference image and the direct images are on the same grid, therefore no source matching was required for source identification.

We used data products described by \cite{Momcheva2016} and the photometric catalog of sources in \cite{Skelton2014} retrieved from the survey's website \footnote{\url{https://3dhst.research.yale.edu/Home.html}}. The extracted 1D spectra in 3D-HST survey are not continuum-corrected as shown in Figure \ref{fig:sensitivity}. We obtained a correct continuum of each 3D-SHT spectrum by dividing the flux of the spectrum and the sensitivity curve of the detector provided in the data. We did not perform any additional reduction to the data.

\subsection{WISP survey data}

The WISP survey is a 1000-orbit HST pure-parallel survey covering 390 fields ($\sim$1500 arcmin$^2$) that follows observing programs accepted on the Cosmic Origins Spectrograph (COS) and Space Telescope Imaging Spectrograph (STIS). The survey's observing strategy as well as data-reduction is described in \cite{2010ApJ...723..104A}. The goal of WISPS is to conduct a census of star-forming high-redshift galaxies. The fields in WISPS were chosen away from the galactic plane and  5.5 and 4.75 arcmin away from the fields of COS and STSIS. Given the pure-parallel nature of this survey, the fields are observed in G102, G141 grism with no dithering between exposure. Reference images were also taken using F110W (corresponding to G102) and F140W (corresponding to G141) imaging cameras. To reach the same depth in both G102 and G141, the ratio of exposure times was fixed at 2.4:1, while the exposure ratio of exposure times for imaging and grism is 6:1.

Data reduction and grism extraction was performed using a combination of \texttt{AXe} software \citep{Kuntschner2013, Kummel2009} and custom IDL pipelines to remove additional background and to flag bad pixels. The main sources of background are zodiacal light, and earth thermal emissions. Grisms spectra in WISPS have little crowding of the same fields given their high galactic latitudes, but multiple spectral orders do overlap. WISPS provides an estimate of contamination of each spectrum computed using \texttt{AXe} and source catalogs in WISPS were generated using SExtractor \citep{1996A&AS..117..393B}. We obtained WISPS G102 and G141 grism data as well as broad-band F110W, F140W, F160W photometric data and source catalogs from the Mukuliski Archive for Space Telescope (MAST \footnote{\url{https://archive.stsci.edu/prepds/wisp/}} ). 


\section{Selection of UCDs}\label{sec:selectionp}

\subsection{Calibration Samples}\label{trainset}

To find a sample of UCDs in WISPS \& 3D-HST data, we created a calibration sample of known UCDs, with similar features, e.g spectral coverage and resolution to define our selection methods and quantity their efficiencies and biases. We obtained 2056 M7-T9 low-resolution ($\sim$75-120), NIR (0.9-2.5 $\micron$) spectra of nearby brown dwarfs with median SNR \textgreater 10 from the SpeX Prism Library (SPL, \citealt{2014arXiv1406.4887B}, \url{https://cass.ucsd.edu/~ajb/browndwarfs/spexprism/library.html}) of UCDs. We will refer to this sample as the templates/SpeX sample. In addition, we compiled a list other UCD spectra taken with the same instrument. We used the 77 UCDs from \cite{Manjavacas2018} observed with the WFC3 as part of a study of cloud properties of hot Jupiters and brown dwarf atmospheres and compilation of a WFC3 UCD library. The Schneider dataset is a list of 22 Y dwarfs obtained by \cite{Schneider2015} using the WFC3 camera with the same resolution and wavelength coverage. These objects were targeted as a part of a program to determine spectroscopic markers of the T/Y dwarf transition. We combined these three sets of spectra. 

\subsection{Pre-selection}

\subsubsection{Point-source Cut}

We combined all grism data and photometry from both surveys and obtained a total of 271915 grisms that have corresponding photometry in the provided photometric catalogs. To narrow down our selection, point sources were identified using \texttt{Source Extractor}'s stellarity index \texttt{CLASS\_STAR} $\neq$0. 3D-HST provides an additional \texttt{star\_flag} flag for point-sources based on their F160W magnitudes and the flag \texttt{FLUX\_RADIUS}, but we find that this flag eliminates 3 UCDs from 3D-HST in the selected sample of UCDs, hence the flag was ignored. We reduced the sample down to 110930 spectra, that is 40.7\% of the total number of spectra.


\subsubsection{J-band SNR rejection }
UCDs display a strong \wat and \meth absorption features in the J and H bands. We do not expect other objects in this survey to display similar molecular broad features, hence to narrow down our selection, we defined a signal-to-noise ratio in the J-band continuum (hereafter J-SNR) in the wavelength region of 1.2 $\micron$ $\leq$ $\lambda$ $\leq$1.3 $\micron$. This J-SNR captures the amount of flux in the J-band, hence we eliminated the lowest SNR objects my making a cut at J-SNR= 3 retaining 46370 spectra/grisms, that is 38.7 \% of the original point-source sample and 15.8\%of the total number of spectra. We also measured the J-SNR for all the spectra in our calibration samples in a similar fashion.

\subsection{Spectral Fitting and F-test}
After the J-SNR cut, we fitted spectra to UCDs SpeX spectra of spectral standards using a $\chi^2$ minimization method, following the method of \cite{2010ApJS..190..100K}. We obtained a spectral type classification all available WISP and 3D-HST spectra. We also compared every spectrum to a straight line in the same wavelength region and measured $\chi^2$.  These two fits help distinguish between spectra that could potentially have absorption features in this region, and spectra that have no interesting features  and/or noisy spectra in this wavelength region. The  $\chi^2 $ of a line ($\chi^2 _L $) or a standard ($\chi^2 _T $) is given by 
\begin{equation}
\chi^2 _L  = \sum _{\lambda = 1.15 \micron} ^{ 1.65 \micron} \frac{(a + b \lambda-\text{Sp} )^2}{ \sigma ^2 }
\end{equation}  
\begin{equation}
\chi^2_T= \sum _{\lambda = 1.15 \micron} ^{ 1.65 \micron} \frac{(\text{Sp}  - \alpha T)^2}{ \sigma ^2 }
\end{equation} 
$\alpha$ is scale-factor defined as 
\begin{equation}\alpha= \sum _{\lambda = 1.15 \micron} ^{ 1.65 \micron} \frac{(\text{Sp} - \alpha T)^2}{\frac{T^2}{\sigma ^2 }} 
\end{equation} $\text{Sp}  (\lambda)$ is a WISP or 3D-HST spectrum and $\sigma ^2 $ is the noise in the WISP or 3D-HST spectrum a and b are the parameters of the best-fit line from least-squares and  T is the template.

 We then use an F-fest as a statistical hypothesis testing static to separate noisy/linear spectra from the rest of the sample implemented by \texttt{Scipy} \citealt{scipy} as \texttt{scipy.stat.f.cdf}. A flat spectrum is defined as having F($\chi^2_s/ \chi ^2 _l)$ \textless 0.4 meaning that the probability of the standard being a better fit to the spectrum than a line is \textless than 40\%. This cut yields only 8148 objects, that is 18.9\% of point-sources with J-SNR\textgreater3, 7.3\% of all point-sources and 3\% of the original number of spectra we obtained from both surveys. These three steps eliminated most of the noisy contaminants.

\subsection{Spectral Indices}

After eliminating noisy and possible extra-galactic contaminants, we narrowed down the selection to true UCDs. UCDs display strong \meth and \wat molecular features in 1.1 $\micron$ \textless $\lambda$ \textless 1.7 $\micron$  region \citep{2001PhDT.......116B}, they can be separated from other stellar/galaxy populations using these features. Spectral Indices have traditionally been used to determine spectral types (\citealt{1999AJ....117.1010T}, \citealt{2000AJ....119.3019C}, \citealt{2007ApJ...657..511A}, \citealt{2007ApJ...658..557B}). Thus, we defined  spectral indices in five wavelength bands: 1.15--1.20 \micron, 1.246--1.295 \micron, 1.38--1.43 \micron,  1.56--1.61 \micron, or 1.62--1.67 \micron; denoted by H$_2$O-1, J-Cont, H$_2$O-1, H-Cont, and \meth respectively. Each index is the ratio of the median flux in these bands and the uncertainties for each index are estimated by random sampling, assuming these uncertainties are Gaussian-distributed. The index is
 given by \begin{equation} Index=\frac{ \langle  F(\lambda_1<\lambda < \lambda_2) \rangle }{  \langle F(\lambda_1 < \lambda <\lambda_2) \rangle }\end{equation}, where at each wavelength i, we draw fluxes normally distributed according to the noise in the spectrum: \begin{equation} \{F(\lambda _i)\} \sim \text{Normal} (<F(\lambda_i)>, \sigma(\lambda_i )) \end{equation}. $\sigma(\lambda_i ))$ is the noise at that wavelength, and $<F(\lambda_i )>$ is the flux at that wavelength.

%Best selection criteria for each subtype
We defined selection criteria using boxes/parallelograms in each of 45 independent, index-spectral index spaces. We expect UCDs with similar spectral types to cluster or follow a linear trend, away from the contaminants while the evolution of the relative strength \wat and \meth bands with subtype should distinguish classes. We chose the following subtypes given their similarities : M7-L0, L0-L5, L5-L0, T0-T5, T5-T9, Y dwarfs and subdwarfs, however, these distinction need not be as rigid.

To define the parameters of each selection criterion/box, we fitted a characteristic line to each index pair (x-index, y-index) within a subtype, defining the slope/direction of the box: y=m$\times$x-index+b. Each box has four vertices (v$_1$, v$_2$, v$_3$, v$_4$)  computed as 
$\text{(xmax, xmin)}= \text{median(x-index)} \pm 3 \times \text{std(x-index)}$. On the x-axis, if xmax is greater than the maximum of x-index, or  if xmin is less than the minimum of the x-index, i.e the box extends beyond the subtype, we set x-min and x-max and the minimum and maximum of x-index respectively. The extent of the boxes on the y-axis are determined by $\text{(ymax, ymin)}= m \times \text{(xmax, xmin)} + b \pm 0.4 \times dy$, where dy is the range of y-index (max(y-index)-min(y-index)). From these values, we define v1= (xmin, ymax), v2=(xmin, ymin), v3=(xmax, ymax), v4=(xmax, ymin). These boxes are designed to enclose most of the objects in each subytpe and to avoid outliers. We used rectangular boxes, for their simplicity, and low-contaminations for subtypes M7--L0, L0--L5, L5--T0, and Y dwarfs, where the vertices were determined in the same manner but with m=0 and b= median(y-index). 

To assess the effectiveness of this method, we defined a completeness and a contamination statistic for each of the subtype group  as follows: 
 \begin{equation} CP=\frac{TEMP_s}{TEMP_{tot}} \end{equation}
\begin{equation} CT= \frac{WFC3_s}{WFC3_{tot}} \end{equation} where $TEMP_s$ is the number of templates selected by the box, $TEMP_{tot}$ is the total number of SpeX templates, $WFC3_s$ is the number of WISPS and/or 3D-HST spectra selected by the box, $WFC3_{tot}$ = 8148 is the total of spectra. We only employed criteria with the lowest contamination and highest completeness to select UCDs. The best criteria for each of the subtype groupings are  those with less than 1\% contamination (except for subdwarfs) and with \textgreater 90\% completeness; they are summarized in Table \ref{tab:criteria}. 

%THE BEST CRITERIA 
As a naming convention, each criteria is named by the ratio of indices on the x-axis and the ratio of fluxes on the y-axis. The best selection criteria are the following for each subtype are: \indxwat-1/J-Cont \indxwat-2/\indxwat-1 for the subtype of L0-L5 sensitive to the \indxwat absorption feature in the J-band; \indxwat-1/J-Cont \indxmeth/H-Cont for the L5-T0 sampling the relative ratio of \indxwat and \meth features; \indxwat-1/J-Cont \indxmeth/\indxwat-1 for the M7-L0 subtypes, sensitive to the \wat in the J-band and \meth features; \indxwat-2/J-Cont \indxmeth/H-Cont for the T0-T5 subtypes, sensitive to the \wat and \meth in the H-band; H-cont/\indxwat-1 \indxmeth/J-Cont for the T5-T9 subtypes, sensitive to \wat and \meth. We use the index \indxmeth/\indxwat-1 \indxwat-2/J-Cont to select Y dwarfs from the Schneider sample and  \indxwat-1/J-Cont \indxmeth/J-Cont for the subdwarfs in the SpeX sample. In total, we selected 2910 spectra out of 8148. The large number comes from high contaminations for the M7-L0 and subdwarf boxes. 
 
As a final step, after all selection has been applied, we visually inspected all the candidates UCDs to confirm their spectral type, and to remove missed outliers. We estimated the false positive rates for our methods after visual inspection and characterization of the UCDS. The false positive rate (FP) is given by \begin{equation}
FP=1-\frac{WFC3_{true}}{WFC3_{s}}
\end{equation} where WFC3$_{true}$ is the total number of objects that are in the spectral type range, and that are true UCDs. Our best selection criteria have FPs \textgreater 90\% which is to box expected given the number of true UCDs is much smaller than the number of spectra. Nevertheless, the number of spectra targeted for visual contamination have been down-selected from more than 200000 to $\sim$ 3000. 


\subsection{Random Forest Classifier}
%justification
As an alternative to using selection boxes in 2D-space, we trained a random forest classifier by deploying \texttt{RandomForestClassifier} implementation by \texttt{scikit-learn} \citep{2012arXiv1201.0490P} to classify potential UCDs in both surveys. Random forests have been shown to reliably predict M-dwarf subytpes based on colors \citep{2019arXiv190505900H} analogous to spectral indices. In addition, random forests have been proven to perform star-galaxy classification in transient surveys, using photometry alone \citep{2017AJ....153...73M}. Random forest algorithms use a set of independent decision trees constructed based on a random set of features, they assign a final label by averaging the classifications obtained by each decision tree. Furthermore, random forests are a reliable method used to obtain classification for large datasets, given that the algorithm is relatively fast, unbiased by noisy features and easy to implement.

 The training set of 11019 objects is composed of 8283 visually confirmed non-UCDs from several iteration of the box-selection method in the previous section, 77 objects from the Manjavacas set, 22 objects form the Schneider set. We labeled these sources using two labels: UCDs, which are objects with spectral types $\geq$ M7, and non-UCDs which are objects with spectral types $\leq$ M7 and/or part of the visually confirmed as non-UCDs.  his labeling results in 2148 objects labeled as UCDs (label=1) 8871 and with label=0. 

%feature selection and accuracy scores
Choosing an appropriate set of features is an important part of designing a good machine learning classifier. By intuition, spectral indices, although they are correlated, are a good set of features to use. We added the signal-to-noise ratio in the J-continuum, the two $\chi^2$s and their ratio, and the F-test value as additional features. For missing features, we replaced those values with -99999.9 and scaled all features in the range [0, 1] using \texttt{MinMaxScaler}. To test the accuracy of our classifier, we use a procedure similar to that of \citep{2017AJ....153...73M}. We used 2-fold cross validation score and split the training by 50\% and 50\% partitions. We computed the accuracy by starting with one index as a feature and then adding additional features. We tracked the accuracy of the classification using cross-validation (CV) scores for each additional feature. With only one spectral index, we achieved a classification score of 75.4\%, with all additional features we achieved a CV score of 98.68 \%. We deployed the classifier on the 110930 point-source objects in both surveys with J-SNR\textgreater 3, classifying 490 sources as UCDs, among which 109 are real UCDs ( M7-T9). The false positive rate (FP) for this method, using the same definition is 77.7\%.

\subsection{Sample Characterization}\label{sec:results}

\subsubsection{M dwarfs}
We found 121 objects with spectral types of M7-M9, these objects are defined by the \wat absorption features at distances between 500 pc and 4 kpc. We show the distance distribution of all the UCDs in the sample in Figure (insert fig ). While T dwarfs are limited in the nearby $\sim$ 500 pc, M and L dwarfs are observed up to $\sim$ 3kpc; this includes sources outside our effective limiting magnitude. The observed galactic distribution of the UCDs is consistent with the galactic distribution and depths of the pointings in the survey. The farthest L dwarf is at xxx and the farthest T dwarf is xx at 2000 pc . This sample include 3 T dwarfs identified by \cite{2012ApJ...752L..14M} including perhaps the farthest spectroscopically-identified T dwarf to known. We report the magnitude distribution of our sample in fig xx and table xx. The faintest objects in the sample have magnitudes of F110W=24.3, F140W=25.2, F160W=25.2. 


\subsubsection{ Robust L \& T dwarfs}
\paragraph{WISP L dwarfs}
We identified x early (L0-L5) L dwarfs in WISP. WISP 0927+6027 is an L0 dwarf at $\sim$ 320 pc discovered in the Par21 pointing of the WISPS survey. It has an apparent magnitude of F140W=18.6 and fits to the L0 dwarf standard with good agreement except for the wavelength ranges of 1.35 to 1.5 \micron and 1.65 to 1.7 \micron due to a possible underestimation or overcorrection of the contamination in those wavelength regions. WISP 1429+3224 is classified as an L0 at $\sim$ 1.5 kpc discovered in the Par378 pointing of the WISP survey. Its apparent magnitude is F140W=22.4 a it has a low SNR (J-SNR=8). Major \wat strength defining that spectral class are present in the spectrum despite the the rise in noise in certain parts of the spectrum. The apparently visual companion is not a UCD, and was not selected by our methods. WISP 1605+1447 is an L0 dwarf at $\sim$ 1.5 kpc found in the Par240 field of the WISP survey. The fit to the standard is relatively poor, and there is a ramp-up of signal $\lambda$ 1.6 \micron, a typical feature in WISP spectra due to a less-precise estimation of the background. WISP 1004+5258 is an L1 dwarf at $\sim$ 1.8 kpc found in the Par438 field/pointing of the WISP survey. There is a puzzling extra flux at 1.3 micron. This object might not be a UCD. WISP 0246-0104 is an L1 dwarf at $\sim$ 1.5 kpc in the Par438 pointing of WISPS. It is a noisier spectrum, but with major features offering a good fit to the standard. WISP 1150-2033 is classified as L1 at $\sim$ 380 pc. It is a bright detection (F160W= 19.2) with a high SNR (J-SNR = 57). It's a good fit to the standard. WISP 0015-7955 is classified as L1 $\sim$ 1.5 kpc in the Par244 pointing. It is a faint source with a J-SNR of 6 and F140W=22.2 but a relatively good fit to the standard. WISP 1618+3340 is another bright L dwarf in WISPS. It has an apparent magnitude of F110W =21.7 putting it at a distance of $\sim$ 1kpc.  WISP 1133+0328 an L1 at $\sim$1 kpc with F140W=22.0  with no particular interesting features. WISP 1154+1941 is an L1 $\sim$1 kpc in a Par338. The spectrum shows a ramp-up in flux at longer wavelength, a common feature in WISP data. 

WISP 1124+4202 is the only late L dwarf in WISPS. Its G141 spectrum with J-SNR =11 is in a good agreement with the SpeX spectral standard. The object has an F160W=21.5 and an estimated distance of $\sim$650 pc.

\paragraph{3D-HST L dwarfs}
For early dwarfs, L1 GOODSS 0333-2751, a bright detection at $\sim$ 1.1 kpc with a brightness of F140W=21.4 and a J-SNR of 34. The G141 spectrum fits well to the standard except for the region $\lambda \in$ [1.3, 1.4] \micron. However, there is no visible contamination in the spectrum at that specific region, the poor fit might be attributed to the telluric correction. UDS 0217-0509 is an L1 dwarf in UDS-25, a nearly perfect fit to the standard. GOODSN 1236+6211 is an L2 dwarf in GOODSN-33 with a J-SNR of 12. The object is in close angular separation with other extra galactic contaminants, but the its spectrum has very little contamination. GOODSN 1236+6209 is a low-SNR detection (J-SNR = 5) classified as L2 at $\sim$4 kpc in the GOODSN-34 pointing. This object is the farthest early L dwarf in the sample. 

\paragraph {WISP T dwarfs}
There are only x early T dwarfs from WISPS in the sample. WISP 1003+2854 is classified as T0 at $\sim$1 kpc. The G141 spectrum displays deep \wat and \meth features with a J-SNR of 6. The spectrum is a poor fit to the standard in noisy regions. The object has a magnitude of F160W=23.1 placing it at $\sim$1 kpc. WISP 0437-1106 is another robust identification, classified as T3 and with an apparent magnitude of F110W=24.3 found in the Par463 pointing of WISP. The J-SNR of the spectrum is 4, and the estimated distance is $\sim$800 pc.

In terms of mid-to late T dwarfs, we found 3 objects previously discovered by \cite{2012ApJ...752L..14M}. WISP0307-7243 is classified as T4 at $\sim$500 pc, WISP1232-0033 is classified as T7 at $\sim$200 pc and  WISP1305-2538 is classified as T9 at $\sim$300 pc. Our classifications and distances agree with the previous classification


\paragraph {3D-HST T dwarfs}

We find one early T dwarf is COSMOS-23: COSMOS1000+0217 is classified as T3 at $\sim$900 pc, with an apparent magnitude of F140W=23.8. The estimated J-SNR of this its G141 spectrum is 5, and the spectrum is a robust fit to the standard. However, given the crowded field, the image is difficult to identify. We found another T dwarf in AEGIS-03, AEGIS1418+5242 is classified as T4, with a high SNR (J-SNR=21) and apparent magnitude of F140W=22.7 implying a distance of $\sim$500 pc. The spectrum is a good it to the spectral standard and there is no visible contamination by nearby objects in the field or other spectral orders. Finally, we detected 2 T dwarfs in the GOODS fields: GOODSS0332-2741 is classified as T6 with a J-SNR=31 and F140W=22.1 placing it at a distance of $\sim$300 pc. GOODSS0332-2749 is classified as a T3 with a J-SNR of 13 at $\sim$500 pc. Both spectra are good fits to the spectral standards. 

\subsubsection{ Subdwarfs, Y dwarfs  \& Binaries}

[WORKING ON THIS SUBSECTION]
We searched for subdwarfs and Y dwarfs by creating selection criteria for these subtypes. However, we did not find any obvious subdwarfs or binaries in the sample with the two methods. This is unsurprising given that estimates of the ratio of subdwarfs to dwarfs is 1/400 (ref) and the binary fraction of UCDs is very low \textless 10 \%. 

\subsubsection{Borderline L \& T dwarfs }

T

\subsubsection{ Absolute Magnitude  Spectral Type Relations }

We create an absolute magnitude-spectral type relation to estimate distances of objects in our observed sample. This relations are built from the relations of \cite{2012ApJS..201...19D}. We first computed an offset/color between 2MASS J and H magnitudes and AB Hubble magnitudes by convolving the SpeX standard for a given spectral type with the respective filter. This offset {}in convolutions is then added to the absolute magnitude-spectral type relations in 2MASS J, H filters to obtain the new relation in Hubble filters. Error propagation is done using Monte-Carlo sampling, we report these relations in Table \ref{tab:polynomials} and show them in Figure \ref{fig:absmagrelations}


\section{Probing Galactic Structure}\label{sec:simulations}

\subsubsection{ Limiting Magnitudes}
We aim to constrain the number density of UCDs; an accurate estimate of the effective distance/volume of each pointing is crucial.  \citealt{Momcheva2016} reported the effective depths of all the pointings in 3D-HST, however, given the SNR cut, we expect the a brighter limit than these reported depths. Hence, we adopted the faintness limits of F110W=22.0, F140W=21.5, F160W=21.5 for WISP fields, and  F140W=22.5, F160W=22.5 for 3D-HST fields. For the bright end, we used the bright limits of F110W=18.0, F140W=16.0, F160W=16.0 for WISPS fields and F140W=16.0, F160W=16.0 for 3D-HST fields following the peak of the distribution of magnitudes (Figure \ref{fig:maglimit}) for all the point sources satisfying the SNR cut. These bright limits correspond to limiting distances hence effective volumes for each spectral type, using the absolute magnitude spectral type relation defined in this work. 

\subsection{Monte-Carlo Simulation}
The observed number of UCDs as a function of spectral type depends on the local luminosity function, the probed effective volume, and selection biases. We construct a Monte-Carlo simulation to fully estimate these effects following methods from \cite{1999ApJ...521..613R} and \cite{2004ApJS..155..191B}. All these steps are illustrated in the graphical model in Figure \ref{fig:graph_model} and explained in this section.

\subsubsection{ Local Luminosity Function} \label{step1simulation}
%motivate: mass function and age distirbtuion are fundemental 
The local luminosity function ($\Phi [mag ^{-1} pc^{-3}]$) of UCDs have been measured using various methods. However, this sample of UCD is distant ($\sim$ kpc), therefore, to avoid any biases, we simulate a "semi-empirical" luminosity function using two fundamental stellar distributions: the mass function and the age distribution as follows: 

\begin{itemize}
\item \textbf{Mass (M), N$_0$ $\leftarrow$ $\alpha$ }: we draw a sample of 2$\times$10$^5$ objects from a power-law mass function parametrized by $\alpha$ for a range of masses between 0.001 \Msun and 0.15 \Msun. \begin{equation}  P(M) = \frac{dN}{dM} \sim \biggl( \frac{M}{M_\sun}\biggl)^{-0.6}\end{equation}. We define a normalization factor ($N_0$) given by \begin{equation} N_0 = 0.005 M_\sun^{-1}pc^{-3} \sum_{ M \in [0.01 M_\sun, 0.09 M_\sun] } M \cdot P(M) \end{equation} as the number density of objects in this simulated sample with masses between 0.01 and 0.9 in our simulation(\citealt{1999ApJ...521..613R}, \citealt{2001ApJ...554.1274C}). For this part of the simulation, the samples of masses were generated by inverting the cumulative distribution (CDF) and using a random number generator to obtain the corresponding values. The CDF (m) for a given mass m is given by \begin{equation} CDF(m) = \frac{1}{C} \int _{M=0.001} ^ {M=m} P(M) dM = \frac{1}{C} \int _{M=0.001} ^ {M=m} M^{-0.6} dM\end{equation}, where C is the normalization constant (i.e CDF for m=0.15). With this mapping, one can obtain different values of the of m by choosing random number x (x=CDF) $\in$ [0, 1.]. 

\item \textbf{Age $\sim$ uniform }: we assigned each of these UCDs an age drawn from a uniform uniform age distribution spanning 100 Myr--10 Gyr. Although there are different parametrization of the star-formation history of the Galaxy, this age distribution correlates with the observed scale heights and velocity distribution of the UCD populations \citep{Ryan2017,2010ApJ...718.1171R,2009MNRAS.397.1286A}. We then keep the age uniform and vary the scale heights, given that varying the scale height is a simpler parametrization. 


\item \textbf{T$_{eff}$ $\leftarrow$ SpT  $\leftarrow$ (Mass, Age) }: we assigned a temperature to each of the simulated objects, using a linear interpolation evolutionary model grids from \cite{2003IAUS..211...41B}. We then converted temperatures to a spectral types (M7-T8) using the polynomial relation from \cite{Filippazzo2015}. This resulting distribution of spectral types will then then be used to estimate our selection biases.

\end{itemize}

\subsubsection{ Effective Volumes}
The observed effective volume of each pointing depends on the scale height and the limiting magnitude of the survey. We compute these volumes using the following steps:
\begin{itemize}
\item The limiting magnitudes for both 3D-HST and WISPS are defined visually as the peak the of magnitude histogram as shown in Figure \ref{fig:maglimit} and explained in section \ref{mag_limits}. These magnitudes provide the distance limits for a given spectral type and pointing d$_{max, min}$ determined by \begin{equation} \log d_{min, max} =\frac{1}{5}(m-M(SpT))+1 \end{equation}
where m in the faint or the bright limit of the survey and M(SpT) is the absolute magnitude for that spectral type. For pointings in 3D-HST, we use F140W magnitudes and for WISP pointings we use F110W magnitudes. Absolute magnitude calculations are described in section \ref{visual}. A complete treatment would account for the effect of dust extinction, however, the pointings in 3D-HST and WISPS are located away from the galactic plane to avoid this problem.

\item We adopt a 1-component galactic disk model parametrized by $\theta=(h, l)$ where h and l are the scale height and the the scale length of a given stellar population. Using \cite{2004ApJS..155..191B}, the spatial density of stars in given direction $\vec{p}$ and distance (d) by
\begin{equation} \rho(\vec{p}, d) =\rho(r, z)= \rho _0 \cdot \text{sech} ^2 \biggl( {\frac{|z-Z_\sun|}{2h}} \biggl) \cdot \exp \biggl( {-\frac{R-R_\sun}{l}} \biggl)\end{equation}. L is fixed at 2600 pc while h is varied from values of 100 pc, 250 pc,  275 pc,  300 pc,  325 pc,  350 pc and 1000 pc drawn from possible values of scale heights predicted from cooling evolutionary models of UCDS  \citep{Ryan2017}. R$_\sun$ and Z$_\sun$ are the sun's position from the galactic center, fixed at 8300 pc and 27 pc respectively. The change from $\rho(\vec{p}, d)$ to $\rho(r, z)$ involves a coordinate transformation from sky to Galactic coordinates.

\item \textbf{ V$_c$ $\leftarrow$ $\theta$=(h, l) and  V$_{eff}$ $\leftarrow$ (d$_{max}$, d$_{min}$, V$_c$)}: given the Galactic structure model, we compute a volume correction (V$_c$) up to distance d, in a given direction $\vec{p}$. This term is the ratio of exponential density to a uniform space density in a given direction. \begin{equation} V_c= \frac{\int_0 ^d\rho(x, \vec{p} ) \cdot x^2 dx} {\int_0 ^x x^2 dx}
\end{equation}, where  x is the 3D-distance in that line of sight. The effective volume of each pointing ($\vec{p}$) and spectral type is \begin{equation}
V_{eff} (\vec{p})= V_c(d_{max}-d_{min}, \vec{p}) \cdot (d_{max}^3-d_{min}^3) \cdot \Delta \Omega  \cdot \frac{1}{3}\end{equation}. Where the $\Delta \Omega$ is the solid angle of each pointing fixed at $\Delta \Omega$ 3.47$\times$ 10$^{-7}$radian$^2$ for each pointing.

\end{itemize}

\subsubsection{Selection Effects}

%%talk about  the sample generation and motivate
Because we applied several selection criteria to narrow down our sample for visual confirmation, it is possible we may have missed a few UCDs in the WISPS/3D-HST fields; particularly low SNR or peculiar objects due, in part, to uncertainties in spectral indices. Hence, the observed volumes objects must corrected by a factor proportional to our selection biases. To fully quantify these effects, we generated a distribution of low-resolution spectra uniformly sampling our SNR distribution across a wide range of SNRs and measured their recovery rate through this selection process by augmenting the SpeX sample to cover 3 orders of magnitude in SNR. To create this sample, we picked the top 20 highest SNR spectra with a median SNR between 50 and 200 L0-T9 objects in the SpeX sample, we added Gaussian noise each spectrum for an iteration of $10^3$ steps creating a new sample of 21800 spectra. Each new "degraded" spectrum is created as \begin{equation} \{F(\lambda _i)\} \sim \text{Normal} (<F(\lambda_i)>, \sigma^t(\lambda_i )) \end{equation}. $\sigma^t(\lambda_i )$ is the the target noise at a wavelength $\lambda_i$, and $<F(\lambda_i )>$ is the flux of the original spectrum at that wavelength. We computed all relevant statistics for each of the degraded spectra, including J-SNR, spectral indices, F-test, and the two $\chi^2$s. We applied our selection processes to this sample of simulated spectra by measuring spectral indices and applying first F-test criterion where F-test \textless 0.4, box index-index selection criteria and the random forest classifier. 

%talk about :"miss-calssifications
In addition, after degrading the spectrum, the object will change its original classification. We defined a selection probability that accounts for the number of objects falling outside our classification range (M7-Y0) after degradation and the selection process itself in a given signa-to-noise range ($\Delta$ J-SNR bin of 2.0). We denote this probability of selection of $\mathcal{S}(\text{J-SNR, SpT})$
\begin{equation}\label{equasl}
\mathcal{S}(\text{J-SNR}_i, \text{SpT})= \frac{N_{s, i} +N_{m, i}}{N_{tot, i}}
\end{equation} where $N_s$ is the number selected spectral type and SNR bin, and $N_{tot}$ is the total number of objects in that bin. Where $N_{s, i}$ is the number of objects in a bin i, selected by our selection process and $N_{m, i}$ is the number of objects in a bin i that fall outside the spectral type range of M7-Y2 after degradation. $N_{tot, i}$ is the total number of spectra in that signal-to-noise ration bin. These selection probabilities are showcased in Figure x.

For each simulated spectral type from the mass function (section \ref{step1simulation}), we computed a selection probability $\mathcal{S}$ parametrized by the expected signal-to-noise ratio (J-SNR) and spectral type (SpT) using the following steps:
\begin{itemize}
\item \textbf{ d $\leftarrow$ ($\theta$=(h, l), d$_{max}$, d$_{min}$)}: we assign a distance to each of drawn from the Galactic structure model. The likelihood of distance (d) given a spectral type  (SpT) pointing $\vec{p}$ \begin{equation}  P(d|\vec{p}) \sim \rho (d, \vec{p}) \cdot d^2 \end{equation}. We then assign each object a randomly drawn distance from all the 533 pointings/directions in both surveys. For a given spectral type the distance is limited to dmin/2 \textless d \textless 10 $\times$ dmax to account for objects scattered in the observed volume. Samples for this part of the simulation were generated using \textt{Pymc} for a number of samples N=20000, sampling each scale height independently using a standard Metropolis-Hastings Algorithm.

\item \textbf{J-SNR  $\leftarrow$  (F110W, F140W, F160W) $\leftarrow$ (d, SpT) }: we estimate an observable signal-to-noise ratio of each object as observed by the WFC3 instrument based on the observed sample. We fit a second-degree polynomial to the observed magnitudes (F110W, F140W, F160W)  and SNR-J of our observed sample. We then use our derived absolute-magnitude spectral type relations to estimate the apparent magnitude of each object in our simulated sample based on its randomly-assigned distance and spectral type. The apparent magnitude- J-SNR relation is then used to estimate a signal-to-noise ratio as observed with the WFC3 instrument. 

\item \textbf{ $\mathcal{S}$  $\leftarrow$ (J-SNR, SpT)}: we assigned a selection probability, as previously defined, to every simulated object in the observed, that is an object with magnitude and signal-noise ratios within our cuts (J-SNR \textless 3 and F110W \textgreater 22.5 (the limiting magnitude from 3D-HST). 

\item The expected number of expected objects per spectral type is then by a simple product of selection probabilities, effective volume scaled by the normalization factor. 
\begin{equation}
N_{sim}(\text{SpT})= N_0 \cdot V_{eff} (\text{SpT}) \cdot \sum _i \mathcal{S}(\text{J-SNR}_i, \text{SpT}) \end{equation}. We compared these numbers to the observed numbers of UCDs for each age distribution in figure \ref{fig:simulationnbrs}

\end{itemize}

\subsection{Results}

%spt distribution 
The resulting spectral type distribution is consistent with expectations given atmospheric cooling effects (\citealt{2004ApJS..155..191B}) from evolutionary models. As UCDs age, they quickly pile up on at the lower end of the spectral type distribution and cooler temperatures. The effective volume for each spectral type and scale heights span 6 orders of magnitude in $pc^3$, and given that earlier spectral types probe larger volumes, the effect of scale heights is more distinguishable for these types (SpT $\leq$ T5). The resulting distribution of distances is smooth, given the simplicity of our Galactic structure model. \cite{Ryan2017} estimated a change in scale height of ($\Delta$h $\sim$50 pc) in the mid-L dwarf regime by comparing galactic models for different cooling scenarios; while the scale height in for late M dwarf and L is consistent with our simulations, and despite the high accuracy in spectral types for the sample of UCDs presented in this study, the relatively small sample size of L\& T dwarfs might not put meaningful constraints on the scale height variations. Nevertheless, the total number of observed M7-T8 dwarfs (136 $\pm$ 11) is consistent with a scale height between 325-350 pc. 


We predict more T dwarfs  observed, in part due to a possible underestimation of the observed volume given that limiting magnitudes were visually estimated [there has be a more empirical way of doing this, like KDEs]. Moreover, the L/T transition region is sensitive to unresolved binaries (\citealt{2014ApJ...794..143B}). \cite{2007ApJ...659..655B} shows that given a spectral binary fraction of $\sim$ 10 \% , the surface densities for volume-limited sample of primaries and combined systems are similar but present a slight bump ($\Delta \Sigma$ $\lesssim$ 5$\times$ 10$^{-5}$ deg$^{-2}$) for early T dwarfs. Given our total search area of $\sim$ 0.6 deg$^2$, we do not expect a significant effect of the spectral binary fraction to the reported densities, hence we assumed that none of the UCDs  in this study are unresolved binaries in our simulation.

%Binary fraction, subdwarf fraction & metallicity effethas no discernable effects (quote Burgasser 2007)
Metallicity effects affect the number of subdwarfs we expected in this sample. UCDs in the thick disk and the halo have similar kinematic ages with stellar populations in these parts of the Galaxy; and UCDs at different metallicities follow different evolutionary tracks. L subdwarfs in the local neighborhood are therefore rare, and this study does not significantly probe large volumes in the thick disk and halo. \cite{Lodieu2017} found 0.04$\times$ deg$^{-2}$ L subdwarfs in the UKIDSS/SDSS fields; in fact, we expect the number of subdwarfs to be $\sim$ 400 times lower than the expected number of dwarfs in the sample. Although the parallel fields in 3D-HST \& WISP are deep, the total search area remains low, hence it is not surprising that we did not find any L subdwarfs in the sample. 

\section{Summary}
%summarize the selection process
The WISPS \& 3D-HST surveys provide NIR G141 (1.1-1.14 \micron) spectroscopic data and broadband F140W, F110W \& F160W photometry for thousands of galaxies and point-sources observed in parallel mode with other on-going HST surveys. We made a point-source cut using in the surveys and obtained 271915 point-sources. Using NIR spectral indices that sample the prominent \wat and \meth absorption features in UCD atmospheres, we created selection criteria based on a calibration sample of templates. We have presented two methods for selecting UCDs in deep HST surveys potentially applicable future infrared parallel surveys. Both methods rely on spectral indices defined to trace \wat and \meth features prominent in the NIR band of UCDS. The box selection method is efficient (completeness \textgreater 90\%) but with relatively high contamination rates that could be significantly reduced by eliminating the lowest SNR sources. This method is not effective for selecting very low SNR sources due to large scatter in indices and early M-dwarfs as the absorption features in these wavelength ranges are shallow. However, these spectral indices are designed to selected T-dwarfs with high accuracy (completeness \textgreater 90\%, contamination \textless 1\%). The overall contamination/false positive rate for this method for spectral types of L0--L5 is $\sim$ 87\% . A second method uses a random forest classifier to distinguish UCDs from other extragalactic contaminants or artifacts with an accuracy score of 99.5\% in cross-validation. The false positive rate of this method  for spectral types of L0--L5 is $\sim$62\%. Both methods rely on a training set of known UCD samples and can be combined.
 With these two methods, we have used these data to obtain 166 spectra of M7-T9 UCDs up to distances $\sim$ 4 kpc. 

%summarize the simulation results
We estimated the expected number of UCDs given a galactic structure model with scale height (h) as a free-parameter. Using a point-source limiting magnitude, we measured the effective volumes of the survey for various values of the scale height. To address intrinsic biases in our selection method, we use a Monte-Carlo simulation to reproduce a distribution of spectral type based on a set of fundamental distribution: mass function, age distribution and conversion/polynomial relation from UCD evolutionary models and our sample. We use the galactic structure model to draw a distribution of distances. With these distributions, we create a selection probability function based on sample of "degraded" templates. The final steps involve summing over selection probabilities. The predicted number of UCDs is consistent with a scale height of 325 pc$\leq$ h $\leq$ 350 pc.  

%Implications for JSWT (quote ryan 2016)
Future space missions such as JSWT, Euclid will be contaminated by UCDs. \cite{RyanJr.2016} predicted that the number density of UCDs (M8--T8) in JSWT fields peaks around J$\sim$24 mag with a total surface density of $\Sigma$ $\sim$ 0.3 arcmin$^{-2}$.  With the \textit{Large-Scale Synopitc Telescope} (LSST), and the \textit{Wide-Field Infrared Survey Telescope} (WFIRST), we expect in increase in both sample size and spectral type accuracy, expanding the parameter space necessary to put significant constraint on the star formation history of the MIlky Way in general and the mass function of UCDs in particular (\citealt{LSSTScienceCollaboration2009},\citealt{Spergel2015}).

%Implications for Euclid deep fields

\acknowledgements
%Acknowledgements
%Wisps funding
%3D-HST 
%LSSTC-DSFP
%Software 
This work is based on observations taken by the 3D-HST treasury program (GO 12177 and 12328) with the NASA/ESA HST, which is operated by the Association of universities for Research in Astronomy, Inc. under NASA contract NAS5-26555.

CA thanks the LSSTC Data Science Fellowship Program, which is funded by LSSTC, NSF Cybertraining Grant \#1829740, the Brinson Foundation, and the Moore Foundation; his participation in the program has benefited this work.

\software{Astropy\citep{Collaboration2013}, 
		Matplotlib \citep{4160265},
		 SPLAT\citep{Burgasser2014}, 
		 Scipy\citep{2019arXiv190710121V}, 
		 Pandas, 
		 Seaborn \citep{michael_waskom_2014_12710}, 
		 Daft,
		 Pymc3\citep{10.7717/peerj-cs.55} }

\clearpage

\input{figures.tex}
\input{tables.tex}
\bibliography{library.bib}
\end{document}


